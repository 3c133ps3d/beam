<!doctype html>
<html lang="en">
<head>
	<title>Beam Wallet Client</title>

	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body>
	<div class="container">
		<h1 class="text-center">Beam Wallet Client</h1>
		<hr>

		<div id="connecting-panel">
			<span class="badge badge-danger">status: connecting to the Wallet Service, please wait...</span>
		</div>

		<form id="create-wallet-panel" style="display: none;">
			<div class="form-group">
				<span class="badge badge-success">status: connected to the Wallet Service</span>
			</div>
			<div class="form-group">
				<label for="seed-phrase-input">Enter seed phrase:</label>
				<input type="text" class="seed-phrase-input form-control" placeholder="Enter seed phrase" value="copy vendor shallow raven coffee appear book blast lock exchange farm glue">
			</div>
			<div class="form-group">
				<label for="wallet-pass-input">Enter wallet password:</label>
				<input type="password" class="wallet-pass-input form-control" placeholder="Enter wallet password" value="456">
			</div>
			<div class="form-group">
				<button type="button" class="create-wallet-button btn btn-primary">
					<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
					Create new wallet
				</button>
			</div>
		</form>

		<form id="open-wallet-panel" style="display: none;">
			<div class="form-group">
				<span class="badge badge-success">status: connected to the Wallet Service</span>
			</div>
			<div class="form-group">
				<label for="wallet-pass-input">Enter wallet password:</label>
				<input type="password" class="wallet-pass-input form-control" placeholder="Enter wallet password" value="456">
			</div>
			<div class="form-group">
				<button type="button" class="open-wallet-button btn btn-primary">
					<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
					Open wallet
				</button>
				or
				<button type="button" class="delete-wallet-button btn btn-danger">
						<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
						Delete wallet
				</button>
			</div>
		</form>

		<form id="wallet-panel" style="display: none;">
			<div class="form-group">
				<span class="badge badge-success">status: connected to the Wallet Service</span>
			</div>
			<div class="form-group">
				Available: <span class="available"></span>
			</div>
			<div class="form-group">
				Current height: <span class="current_height"></span>
			</div>
			<hr>
			<h3>Addresses</h3>
			<table class="table addresses">
				<thead>
					<tr>
						<th>#</th>
						<th>address</th>
						<th>comment</th>
						<th>create_time</th>
						<th>duration</th>
						<th>expired</th>
						<th>own</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
			<hr>
			<button type="button" class="close-wallet-button btn btn-secondary">
				Close wallet
			</button>
		</form>		
	
	</div>
</body>

	<script src='wasm-key-keeper.js'></script>

	<script type="text/javascript">

		Module().then(function(Module)
        {
			var connection = null;
			var keykeeper = null

			function showPanel(id)
			{
				['#connecting-panel', '#create-wallet-panel', '#open-wallet-panel', '#wallet-panel'].forEach(name => $(name).hide())
				$(id).show()
			}
		
			function start()
			{
				const url = 'ws://127.0.0.1:8080'
				connection = new WebSocket(url)

				connection.onopen = () => 
				{
					console.log('Connected to the Wallet Servce...')			
					refresh()
				}
				
				connection.onclose = () =>
				{
					showPanel('#connecting-panel')

					console.log('connection lost, reconnecting...')

					setTimeout(start, 5000)
				}

				connection.onerror = error => 
				{
					console.log(`connection error: ${error}`)
				}
			}

			start();

			function initKeyKeeper(seed)
			{
				var wordList = new Module.WordList()
				seed.split(' ').forEach((word) => wordList.push_back(word))
				return new Module.KeyKeeper(wordList)
			}

			$('#open-wallet-panel .delete-wallet-button').click(() => 
			{
				if (confirm('Are you sure want do delete current wallet data?')) 
				{
					localStorage.clear()
					refresh()
				}
			})

			function showAddresses()
			{
				connection.onmessage = e => 
				{
					console.log(`got response: ${e.data}`)

					var data = JSON.parse(e.data)

					if(data.result)
					{
						var body = $('#wallet-panel .addresses > tbody')
							.empty()

						data.result.forEach((item, index) => body.append(`<tr>
							<td>${index+1}</td>
							<td>${item.address}</td>
							<td>${item.comment}</td>
							<td>${item.create_time}</td>
							<td>${item.duration}</td>
							<td>${item.expired}</td>
							<td>${item.own}</td>
							</tr>`))
					}
					else onkeykeeper(data)

					if($('#wallet-panel').is(":visible"))
						setTimeout(showWalletStatus, 5000)
				}

				connection.send(JSON.stringify(
				{
					jsonrpc:'2.0',
					id: 0,
					method: 'addr_list',
					params:
					{
						own: true
					}
				}))
			}

			function showWalletStatus()
			{
				connection.onmessage = e => 
				{
					console.log(`got response: ${e.data}`)

					var data = JSON.parse(e.data)

					if(data.result)
					{
						$("#wallet-panel .available").text(data.result.available)
						$("#wallet-panel .current_height").text(data.result.current_height)

						showAddresses()
					}
					else onkeykeeper(data)
				}

				connection.send(JSON.stringify(
				{
					jsonrpc:'2.0',
					id: 0,
					method: 'wallet_status'
				}))
			}

			$('#open-wallet-panel .open-wallet-button').click(() => 
			{
				console.log(`Opening wallet with seed phrase: ${localStorage.seed}`)
				keykeeper = initKeyKeeper(localStorage.seed)
				var walletPass = $('#open-wallet-panel .wallet-pass-input').val()

				connection.onmessage = e => 
				{
					console.log(`got response: ${e.data}`)

					var data = JSON.parse(e.data)

					if(data.result && data.result.length)
					{
						console.log(`wallet session: ${data.result}`)

						showPanel('#wallet-panel')

						showWalletStatus()
					}
					else onkeykeeper(data)
				}

				connection.send(JSON.stringify(
				{
					jsonrpc:'2.0',
					id: 0,
					method: 'open_wallet',
					params: 
					{
						id: localStorage.id,
						pass: walletPass
					}
				}))
			})

			function sendKeykeeperResult(id, result)
			{
				connection.send(JSON.stringify(
					{
						jsonrpc:'2.0', 
						id: id,
						result: result
					})
				)
			}

			function onkeykeeper(data)
			{
				var handlers = 
				{
					generate_key: () => sendKeykeeperResult(data.id, keykeeper.generatePublicKey(data.params.id, data.params.create_coin_key)),
					allocate_nonce_slot: () => sendKeykeeperResult(data.id, keykeeper.allocateNonceSlot()),
				}

				handlers[data.method] 
					? handlers[data.method]() 
					: console.log(`Unknown Key Keeper method: ${data.method}`)
			}

			$('#create-wallet-panel .create-wallet-button').click(() => 
			{
				var seed = $('#create-wallet-panel .seed-phrase-input').val()
				console.log(`Creating new wallet with seed phrase: ${seed}`)

				keykeeper = initKeyKeeper(seed)
				var walletPass = $('#create-wallet-panel .wallet-pass-input').val()
				var ownerKey = keykeeper.getOwnerKey(walletPass)

				console.log('ownerKey is: data:application/octet-stream;base64,' + ownerKey)

				$('#create-wallet-panel .create-wallet-button')
					.attr('disabled', true)
					.find('.spinner-border').show()

				connection.onmessage = e => 
				{
					console.log(`got response: ${e.data}`)

					var data = JSON.parse(e.data)

					if(data.result && data.result.length)
					{
						console.log(`result is: ${data.result}`)

						localStorage.clear()
						localStorage.seed = seed
						localStorage.id = data.result

						$('#create-wallet-panel .create-wallet-button')
							.attr('disabled', false)
							.find('.spinner-border').hide()

						refresh()
					}
					else onkeykeeper(data)
				}

				connection.send(JSON.stringify(
				{
					jsonrpc:'2.0',
					id: 0,
					method: 'create_wallet',
					params: 
					{
						pass: walletPass,
						ownerkey: ownerKey
					}
				}))
			})

			function refresh()
			{
				if(localStorage.id) showPanel('#open-wallet-panel')
				else showPanel('#create-wallet-panel')
			}
		})

	</script>

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</html>